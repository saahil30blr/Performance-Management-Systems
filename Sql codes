-- Create the tables
CREATE TABLE managers (
    manager_id SERIAL PRIMARY KEY,
    manager_name VARCHAR(255) NOT NULL
);

CREATE TABLE employees (
    employee_id SERIAL PRIMARY KEY,
    employee_name VARCHAR(255) NOT NULL,
    manager_id INT REFERENCES managers(manager_id)
);

CREATE TABLE goals (
    goal_id SERIAL PRIMARY KEY,
    employee_id INT REFERENCES employees(employee_id),
    goal_description TEXT NOT NULL,
    due_date DATE NOT NULL,
    status VARCHAR(50) NOT NULL CHECK (status IN ('Draft', 'In Progress', 'Completed', 'Cancelled'))
);

CREATE TABLE tasks (
    task_id SERIAL PRIMARY KEY,
    goal_id INT REFERENCES goals(goal_id),
    task_description TEXT NOT NULL,
    task_status VARCHAR(50) NOT NULL CHECK (task_status IN ('To Do', 'In Progress', 'Done'))
);

CREATE TABLE feedback (
    feedback_id SERIAL PRIMARY KEY,
    goal_id INT REFERENCES goals(goal_id),
    feedback_text TEXT NOT NULL,
    feedback_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE goal_log (
    log_id SERIAL PRIMARY KEY,
    goal_id INT,
    old_status VARCHAR(50),
    new_status VARCHAR(50),
    change_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create a trigger for automated feedback
CREATE OR REPLACE FUNCTION log_goal_status_change()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO goal_log (goal_id, old_status, new_status)
    VALUES (OLD.goal_id, OLD.status, NEW.status);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER goal_status_change_trigger
AFTER UPDATE OF status ON goals
FOR EACH ROW
WHEN (OLD.status IS DISTINCT FROM NEW.status)
EXECUTE FUNCTION log_goal_status_change();

-- Insert some sample data
INSERT INTO managers (manager_name) VALUES ('Alice'), ('Bob');
INSERT INTO employees (employee_name, manager_id) VALUES ('Charlie', 1), ('David', 1), ('Eve', 2);
INSERT INTO goals (employee_id, goal_description, due_date, status) VALUES
(1, 'Increase sales by 10%', '2025-12-31', 'In Progress'),
(2, 'Develop a new feature', '2025-11-30', 'Draft'),
(3, 'Complete the marketing campaign', '2025-10-31', 'Completed');
INSERT INTO tasks (goal_id, task_description, task_status) VALUES
(1, 'Contact 10 new leads', 'In Progress'),
(1, 'Follow up with existing clients', 'To Do'),
(3, 'Launch social media ads', 'Done');
INSERT INTO feedback (goal_id, feedback_text) VALUES
(1, 'Great start, keep up the momentum!'),
(3, 'Excellent work on the campaign, it was a huge success.');
